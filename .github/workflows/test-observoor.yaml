name: Test Observoor

on:
  pull_request:
    paths:
      - 'charts/observoor/**'
  workflow_dispatch:

jobs:
  test-observoor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v3.18.4

      - name: Create kind cluster
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0

      - name: Deploy Ethereum node (geth + lighthouse)
        run: |
          echo "üöÄ Deploying ethereum-node (geth + lighthouse)..."

          # Add helm repo and build dependencies
          helm repo add ethereum-helm-charts https://ethpandaops.github.io/ethereum-helm-charts
          helm dependency build charts/ethereum-node

          # Install ethereum-node with geth + lighthouse
          helm install eth-node charts/ethereum-node \
            --set global.main.network=mainnet \
            --set global.checkpointSync.enabled=true \
            --set execution.client=geth \
            --set consensus.client=lighthouse \
            --set execution.livenessProbe.initialDelaySeconds=300 \
            --set execution.readinessProbe.initialDelaySeconds=300 \
            --set consensus.livenessProbe.initialDelaySeconds=300 \
            --set consensus.readinessProbe.initialDelaySeconds=300

          echo "‚è≥ Waiting for pods to be Running..."
          for i in {1..90}; do
            EL_STATUS=$(kubectl get pod -l app.kubernetes.io/name=geth -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
            CL_STATUS=$(kubectl get pod -l app.kubernetes.io/name=lighthouse -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
            echo "  EL: $EL_STATUS, CL: $CL_STATUS ($i/90)"

            if [ "$EL_STATUS" = "Running" ] && [ "$CL_STATUS" = "Running" ]; then
              echo "‚úÖ Both pods are running"
              break
            fi
            sleep 5
          done

          # Give them a moment to initialize
          sleep 10

          # Wait for beacon API to respond
          echo "‚è≥ Waiting for beacon API..."
          kubectl port-forward svc/eth-node-lighthouse 5052:5052 &
          PF_PID=$!
          sleep 3

          for i in {1..30}; do
            if curl -s http://localhost:5052/eth/v1/beacon/genesis 2>/dev/null | grep -q genesis_time; then
              echo "‚úÖ Beacon API is responding"
              break
            fi
            echo "  Waiting for beacon API... ($i/30)"
            sleep 5
          done

          kill $PF_PID 2>/dev/null || true
          echo "‚úÖ Ethereum node is ready"

          # Verify service exists and DNS resolves
          echo "‚è≥ Verifying services..."
          kubectl get svc

          # Wait a bit more for DNS to propagate
          sleep 5

      - name: Deploy Observoor
        run: |
          echo "üöÄ Deploying Observoor..."

          # Install observoor pointing at the beacon service
          helm install observoor charts/observoor \
            --set config.beacon.endpoint=http://eth-node-lighthouse:5052 \
            --set config.sinks.raw.enabled=false \
            --set config.sinks.slot.enabled=false \
            --set livenessProbe.initialDelaySeconds=30 \
            --set readinessProbe.initialDelaySeconds=5 \
            --timeout 5m

          echo "‚úÖ Observoor deployed"

      - name: Wait for Observoor to start
        run: |
          echo "‚è≥ Waiting for observoor pod to be created..."

          # Wait for pod to exist
          for i in {1..30}; do
            if kubectl get pod -l app.kubernetes.io/name=observoor 2>/dev/null | grep -q observoor; then
              echo "Pod found"
              break
            fi
            echo "Waiting for pod... ($i/30)"
            sleep 2
          done

          # Get pod name
          POD=$(kubectl get pod -l app.kubernetes.io/name=observoor -o jsonpath='{.items[0].metadata.name}')
          echo "Pod: $POD"

          # Wait up to 3 minutes for pod to be running and stable
          echo "‚è≥ Waiting for pod to be running..."
          for i in {1..90}; do
            STATUS=$(kubectl get pod $POD -o jsonpath='{.status.phase}' 2>/dev/null || echo "Pending")
            READY=$(kubectl get pod $POD -o jsonpath='{.status.containerStatuses[0].ready}' 2>/dev/null || echo "false")
            RESTARTS=$(kubectl get pod $POD -o jsonpath='{.status.containerStatuses[0].restartCount}' 2>/dev/null || echo "0")

            echo "  Status: $STATUS, Ready: $READY, Restarts: $RESTARTS ($i/90)"

            # Check if pod is ready (ideal)
            if [ "$READY" = "true" ]; then
              echo "‚úÖ Pod is ready"
              break
            fi

            # If running but not ready, check logs for errors
            if [ "$STATUS" = "Running" ] && [ "$RESTARTS" -gt "2" ]; then
              echo "‚ö†Ô∏è  Pod is crash-looping, checking logs..."
              kubectl logs $POD --tail=20 || true
              # Continue waiting - maybe it will stabilize
            fi

            # If more than 5 restarts, give up
            if [ "$RESTARTS" -gt "5" ]; then
              echo "‚ùå Pod is crash-looping too much"
              kubectl describe pod $POD
              kubectl logs $POD || true
              exit 1
            fi

            sleep 2
          done

          # Final status check
          echo ""
          echo "üìä Final pod status:"
          kubectl get pod $POD

      - name: Check Observoor logs and metrics
        run: |
          POD=$(kubectl get pod -l app.kubernetes.io/name=observoor -o jsonpath='{.items[0].metadata.name}')

          echo "üìã Observoor logs:"
          kubectl logs $POD --tail=50 || true

          echo ""
          echo "üìä Checking metrics endpoint..."

          # Port forward and check metrics
          kubectl port-forward $POD 9090:9090 &
          PF_PID=$!
          sleep 3

          # Fetch metrics
          METRICS=$(curl -s http://localhost:9090/metrics 2>/dev/null || echo "")

          kill $PF_PID 2>/dev/null || true

          if [ -z "$METRICS" ]; then
            echo "‚ö†Ô∏è  Could not fetch metrics (pod may still be starting)"
            echo "Checking if pod is at least running..."
            kubectl get pod $POD
            exit 0
          fi

          echo "‚úÖ Metrics endpoint is responding"

          # Check for key metrics
          echo ""
          echo "üîç Key metrics:"
          echo "$METRICS" | grep -E "^observoor_(pids_tracked|bpf_programs_attached|events_received)" || echo "  (metrics not yet available)"

          # Check if PIDs are being tracked (success indicator)
          PIDS_TRACKED=$(echo "$METRICS" | grep "^observoor_pids_tracked " | awk '{print $2}' || echo "0")
          echo ""
          echo "PIDs tracked: $PIDS_TRACKED"

          # Check BPF programs attached
          BPF_ATTACHED=$(echo "$METRICS" | grep "^observoor_bpf_programs_attached" | head -1 || echo "")
          if [ -n "$BPF_ATTACHED" ]; then
            echo "BPF programs: $BPF_ATTACHED"
          fi

      - name: Collect debug info on failure
        if: failure()
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -A

          echo ""
          echo "=== Observoor Pod Description ==="
          kubectl describe pod -l app.kubernetes.io/name=observoor || true

          echo ""
          echo "=== Observoor Logs ==="
          kubectl logs -l app.kubernetes.io/name=observoor --tail=100 || true

          echo ""
          echo "=== Geth Pod Status ==="
          kubectl describe pod -l app.kubernetes.io/name=geth || true

          echo ""
          echo "=== Geth Logs ==="
          kubectl logs -l app.kubernetes.io/name=geth --tail=50 || true

          echo ""
          echo "=== Lighthouse Pod Status ==="
          kubectl describe pod -l app.kubernetes.io/name=lighthouse || true

          echo ""
          echo "=== Lighthouse Logs ==="
          kubectl logs -l app.kubernetes.io/name=lighthouse --tail=50 || true

          echo ""
          echo "=== Events ==="
          kubectl get events --sort-by='.lastTimestamp' | tail -30
