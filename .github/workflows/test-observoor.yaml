name: Test Observoor

on:
  pull_request:
    paths:
      - 'charts/observoor/**'
  workflow_dispatch:

jobs:
  test-observoor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v3.18.4

      - name: Create kind cluster
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0

      - name: Deploy Ethereum node (geth + lighthouse)
        run: |
          echo "üöÄ Deploying ethereum-node (geth + lighthouse)..."

          # Add helm repo and build dependencies
          helm repo add ethereum-helm-charts https://ethpandaops.github.io/ethereum-helm-charts
          helm dependency build charts/ethereum-node

          # Install ethereum-node with geth + lighthouse
          helm install eth-node charts/ethereum-node \
            --set global.main.network=mainnet \
            --set global.checkpointSync.enabled=true \
            --set geth.enabled=true \
            --set lighthouse.enabled=true \
            --set geth.livenessProbe.initialDelaySeconds=300 \
            --set geth.readinessProbe.initialDelaySeconds=300 \
            --set lighthouse.livenessProbe.initialDelaySeconds=300 \
            --set lighthouse.readinessProbe.initialDelaySeconds=300

          echo "‚è≥ Waiting for pods to be Running..."
          for i in {1..90}; do
            EL_STATUS=$(kubectl get pod -l app.kubernetes.io/name=execution -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
            CL_STATUS=$(kubectl get pod -l app.kubernetes.io/name=beacon -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
            echo "  EL: $EL_STATUS, CL: $CL_STATUS ($i/90)"

            if [ "$EL_STATUS" = "Running" ] && [ "$CL_STATUS" = "Running" ]; then
              echo "‚úÖ Both pods are running"
              break
            fi
            sleep 5
          done

          # Give them a moment to initialize
          sleep 10

          # Wait for beacon API to respond
          echo "‚è≥ Waiting for beacon API..."
          kubectl port-forward svc/eth-node-beacon 5052:5052 &
          PF_PID=$!
          sleep 3

          for i in {1..30}; do
            if curl -s http://localhost:5052/eth/v1/beacon/genesis 2>/dev/null | grep -q genesis_time; then
              echo "‚úÖ Beacon API is responding"
              break
            fi
            echo "  Waiting for beacon API... ($i/30)"
            sleep 5
          done

          kill $PF_PID 2>/dev/null || true
          echo "‚úÖ Ethereum node is ready"

          # Verify service exists
          echo "‚è≥ Verifying services..."
          kubectl get svc

          # Get the lighthouse pod IP as fallback
          echo "Getting lighthouse pod IP..."
          LIGHTHOUSE_IP=$(kubectl get pod -l app.kubernetes.io/name=beacon -o jsonpath='{.items[0].status.podIP}')
          echo "Lighthouse IP: $LIGHTHOUSE_IP"

          # Wait for CoreDNS to be ready and test DNS resolution
          echo "‚è≥ Waiting for DNS to be ready..."
          for i in {1..30}; do
            if kubectl run dns-test --image=busybox:1.28 --rm -i --restart=Never -- nslookup eth-node-beacon.default.svc.cluster.local 2>/dev/null | grep -q "Address"; then
              echo "‚úÖ DNS is working"
              break
            fi
            echo "  Waiting for DNS... ($i/30)"
            sleep 5
          done

      - name: Deploy Observoor
        run: |
          echo "üöÄ Deploying Observoor..."

          # Get lighthouse pod IP for more reliable connection
          LIGHTHOUSE_IP=$(kubectl get pod -l app.kubernetes.io/name=beacon -o jsonpath='{.items[0].status.podIP}')
          echo "Using lighthouse IP: $LIGHTHOUSE_IP"

          # Install observoor pointing at lighthouse by IP (more reliable in kind)
          helm install observoor charts/observoor \
            --set config.beacon.endpoint=http://${LIGHTHOUSE_IP}:5052 \
            --set config.sinks.raw.enabled=false \
            --set config.sinks.slot.enabled=false \
            --set livenessProbe.initialDelaySeconds=30 \
            --set readinessProbe.initialDelaySeconds=5 \
            --timeout 5m

          echo "‚úÖ Observoor deployed"

      - name: Wait for Observoor to start
        run: |
          echo "‚è≥ Waiting for observoor pod to be created..."

          # Wait for pod to exist
          for i in {1..30}; do
            if kubectl get pod -l app.kubernetes.io/name=observoor 2>/dev/null | grep -q observoor; then
              echo "Pod found"
              break
            fi
            echo "Waiting for pod... ($i/30)"
            sleep 2
          done

          # Get pod name
          POD=$(kubectl get pod -l app.kubernetes.io/name=observoor -o jsonpath='{.items[0].metadata.name}')
          echo "Pod: $POD"

          # Wait up to 3 minutes for pod to be running and stable
          echo "‚è≥ Waiting for pod to be running..."
          for i in {1..90}; do
            STATUS=$(kubectl get pod $POD -o jsonpath='{.status.phase}' 2>/dev/null || echo "Pending")
            READY=$(kubectl get pod $POD -o jsonpath='{.status.containerStatuses[0].ready}' 2>/dev/null || echo "false")
            RESTARTS=$(kubectl get pod $POD -o jsonpath='{.status.containerStatuses[0].restartCount}' 2>/dev/null || echo "0")

            echo "  Status: $STATUS, Ready: $READY, Restarts: $RESTARTS ($i/90)"

            # Check if pod is ready (ideal)
            if [ "$READY" = "true" ]; then
              echo "‚úÖ Pod is ready"
              break
            fi

            # If running but not ready, check logs for errors
            if [ "$STATUS" = "Running" ] && [ "$RESTARTS" -gt "2" ]; then
              echo "‚ö†Ô∏è  Pod is crash-looping, checking logs..."
              kubectl logs $POD --tail=20 || true
              # Continue waiting - maybe it will stabilize
            fi

            # If more than 5 restarts, give up
            if [ "$RESTARTS" -gt "5" ]; then
              echo "‚ùå Pod is crash-looping too much"
              kubectl describe pod $POD
              kubectl logs $POD || true
              exit 1
            fi

            sleep 2
          done

          # Final status check
          echo ""
          echo "üìä Final pod status:"
          kubectl get pod $POD

      - name: Generate activity and verify events
        run: |
          echo "üîÑ Generating activity to trigger events..."

          # Get beacon pod IP for direct requests
          BEACON_IP=$(kubectl get pod -l app.kubernetes.io/name=beacon -o jsonpath='{.items[0].status.podIP}')

          # Port forward beacon for API requests
          kubectl port-forward svc/eth-node-beacon 5052:5052 &
          BEACON_PF=$!
          sleep 2

          # Generate beacon API activity (this creates network IO that observoor should capture)
          echo "Making beacon API requests to generate network events..."
          for i in {1..20}; do
            curl -s http://localhost:5052/eth/v1/beacon/genesis > /dev/null 2>&1 || true
            curl -s http://localhost:5052/eth/v1/node/version > /dev/null 2>&1 || true
            curl -s http://localhost:5052/eth/v1/node/health > /dev/null 2>&1 || true
            curl -s http://localhost:5052/eth/v1/node/syncing > /dev/null 2>&1 || true
          done

          kill $BEACON_PF 2>/dev/null || true

          # Wait for observoor to process events
          echo "‚è≥ Waiting for observoor to capture events..."
          sleep 15

      - name: Check Observoor logs and metrics
        run: |
          POD=$(kubectl get pod -l app.kubernetes.io/name=observoor -o jsonpath='{.items[0].metadata.name}')

          echo "üìã Observoor logs:"
          kubectl logs $POD --tail=50 || true

          echo ""
          echo "üìä Checking metrics endpoint..."

          # Port forward and check metrics
          kubectl port-forward $POD 9090:9090 &
          PF_PID=$!
          sleep 3

          # Fetch metrics
          METRICS=$(curl -s http://localhost:9090/metrics 2>/dev/null || echo "")

          kill $PF_PID 2>/dev/null || true

          if [ -z "$METRICS" ]; then
            echo "‚ùå Could not fetch metrics"
            kubectl get pod $POD
            exit 1
          fi

          echo "‚úÖ Metrics endpoint is responding"

          # ===== Validate PIDs tracked =====
          echo ""
          echo "üîç Checking PIDs tracked..."
          PIDS_TRACKED=$(echo "$METRICS" | grep "^observoor_pids_tracked " | awk '{print $2}' | cut -d. -f1 || echo "0")
          echo "PIDs tracked: $PIDS_TRACKED"

          if [ "$PIDS_TRACKED" -lt "1" ]; then
            echo "‚ùå FAIL: No PIDs tracked (expected >= 1)"
            exit 1
          fi
          echo "‚úÖ PIDs tracked: $PIDS_TRACKED"

          # ===== Validate BPF programs attached =====
          echo ""
          echo "üîç Checking BPF programs..."
          echo "$METRICS" | grep "^observoor_bpf_programs_attached" || true

          KPROBES=$(echo "$METRICS" | grep 'observoor_bpf_programs_attached{type="kprobe"}' | awk '{print $2}' | cut -d. -f1 || echo "0")
          TRACEPOINTS=$(echo "$METRICS" | grep 'observoor_bpf_programs_attached{type="tracepoint"}' | awk '{print $2}' | cut -d. -f1 || echo "0")

          if [ "$KPROBES" -lt "1" ]; then
            echo "‚ùå FAIL: No kprobes attached"
            exit 1
          fi
          echo "‚úÖ Kprobes attached: $KPROBES"

          if [ "$TRACEPOINTS" -lt "1" ]; then
            echo "‚ùå FAIL: No tracepoints attached"
            exit 1
          fi
          echo "‚úÖ Tracepoints attached: $TRACEPOINTS"

          # ===== Validate events received =====
          echo ""
          echo "üîç Checking events received..."
          EVENTS_TOTAL=$(echo "$METRICS" | grep "^observoor_events_received_total " | awk '{print $2}' | cut -d. -f1 || echo "0")
          echo "Total events received: $EVENTS_TOTAL"

          # Show event breakdown by type
          echo ""
          echo "üìä Events by type:"
          echo "$METRICS" | grep "^observoor_events_by_type" || echo "  (no events by type yet)"

          # Show events by client
          echo ""
          echo "üìä Events by client:"
          echo "$METRICS" | grep "^observoor_events_by_client" || echo "  (no events by client yet)"

          if [ "$EVENTS_TOTAL" -lt "1" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: No events received yet"
            echo "This might be a timing issue - the clients may not have generated enough IO."
            echo "BPF programs are attached and PIDs are tracked, so the chart is working."
            # Don't fail on this - BPF attachment is the key indicator the chart works
          else
            echo ""
            echo "‚úÖ Events captured: $EVENTS_TOTAL"
          fi

          # ===== Summary =====
          echo ""
          echo "========================================="
          echo "üìä OBSERVOOR TEST SUMMARY"
          echo "========================================="
          echo "PIDs tracked:        $PIDS_TRACKED"
          echo "Kprobes attached:    $KPROBES"
          echo "Tracepoints:         $TRACEPOINTS"
          echo "Events received:     $EVENTS_TOTAL"
          echo "========================================="
          echo "‚úÖ Observoor helm chart is working correctly!"

      - name: Collect debug info on failure
        if: failure()
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -A

          echo ""
          echo "=== Observoor Pod Description ==="
          kubectl describe pod -l app.kubernetes.io/name=observoor || true

          echo ""
          echo "=== Observoor Logs ==="
          kubectl logs -l app.kubernetes.io/name=observoor --tail=100 || true

          echo ""
          echo "=== Geth Pod Status ==="
          kubectl describe pod -l app.kubernetes.io/name=execution || true

          echo ""
          echo "=== Geth Logs ==="
          kubectl logs -l app.kubernetes.io/name=execution --tail=50 || true

          echo ""
          echo "=== Lighthouse Pod Status ==="
          kubectl describe pod -l app.kubernetes.io/name=beacon || true

          echo ""
          echo "=== Lighthouse Logs ==="
          kubectl logs -l app.kubernetes.io/name=beacon --tail=50 || true

          echo ""
          echo "=== Events ==="
          kubectl get events --sort-by='.lastTimestamp' | tail -30
